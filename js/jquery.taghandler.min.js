(function(e){function n(e,t){var n=false;jQuery.each(t,function(t,r){if(r===e){n=true;return false}});return n}function r(e,t){jQuery.each(t,function(n,r){if(r===e){t.splice(n,1)}});return t}function i(t,n,i,s){i.assignedTags.push(n);i.availableTags=r(n,i.availableTags);e("<li />").addClass("tagItem").text(n).insertBefore(e(t).parent());if(s){i=o(i)}return i}function s(t,i,s){var u=e(t).text();i.assignedTags=r(u,i.assignedTags);if(n(u,i.originalTags)){i.availableTags.push(u)}e(t).remove();if(s){i=o(i)}return i}function o(e){e.availableTags=e.availableTags.sort();e.assignedTags=e.assignedTags.sort();e.originalTags=e.originalTags.sort();return e}function u(t,n,r){var i={tags:t.assignedTags};e.extend(i,n.updateData);e.ajax({type:"POST",url:n.updateURL,cache:false,data:i,dataType:"json",beforeSend:function(){if(e("#"+r+"_save").length){e("#"+r+"_save").fadeOut(200,function(){e("#"+r+"_loader").fadeIn(200)})}else{e("#"+r+"_loader").fadeIn(200)}},complete:function(){e("#"+r+"_loader").fadeOut(200,function(){if(e("#"+r+"_save").length){e("#"+r+"_save").fadeIn(200)}})}})}function a(t,n,i,s){e(n.assignedTags).each(function(o,u){if(t.allowEdit){e("<li />").addClass("tagItem").text(u).insertBefore(e(i).parent())}else{e("<li />").addClass("tagItem").css("cursor","default").text(u).appendTo(e(s))}n.availableTags=r(u,n.availableTags)});return n}function f(t,n){if(n.debug&&window.console&&window.console.log){window.console.log(t);window.console.log(n);window.console.log(e.fn.tagHandler.defaults)}}var t={getSerializedTags:function(){var t=[];e(this).find("li.tagItem").each(function(n,r){t.push(e(r).text())});return t.join(",")},getTags:function(){var t=[];e(this).find("li.tagItem").each(function(n,r){t.push(e(r).text())});return t},version:function(){return"1.3.0"}};e.fn.tagHandler=function(r){if(typeof r=="object"||typeof r=="undefined"){var l=e.extend({},e.fn.tagHandler.defaults,r);f(e(this),l);return this.each(function(){if(!e(this).is("ul")){return true}var t=this;var r=e(t);if(!t.id){var c=new Date;t.id=c.getTime()}r.wrap('<div class="'+l.className+'" />');r.addClass(l.className+"Container");if(l.allowEdit){r.html('<li class="tagInput"><input class="tagInputField" type="text" placeholder="'+l.placeHolder+'" /></li>')}var h=r.find(".tagInputField");var p=[];p.availableTags=[];p.originalTags=[];p.assignedTags=[];if(l.updateURL!==""){if(!l.autoUpdate){e("<div />").attr({id:t.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){u(p,l,t.id)}).appendTo(r.parent())}e("<div />").attr({id:t.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo(r.parent())}if(l.getURL!==""&&l.initLoad){e.ajax({url:l.getURL,cache:false,data:l.getData,dataType:"json",success:function(n,r,i){if(n.availableTags.length){p.availableTags=n.availableTags.slice();p.originalTags=p.availableTags.slice()}if(l.sortTags){p=o(p)}if(n.assignedTags.length){p.assignedTags=n.assignedTags.slice();if(l.sortTags){p=o(p)}p=a(l,p,h,t)}if(l.autocomplete&&typeof e.fn.autocomplete=="function"&&l.allowEdit){e(h).autocomplete("option","source",p.availableTags)}},error:function(e,t,n){f(e,t,n);alert(l.msgError)}})}else if(l.getURL!==""){p.assignedTags=l.assignedTags.slice();if(l.sortTags){p=o(p)}p=a(l,p,h,t)}else{if(l.availableTags.length){p.availableTags=l.availableTags.slice();p.originalTags=p.availableTags.slice()}if(l.sortTags){p=o(p)}if(l.assignedTags.length){p.assignedTags=l.assignedTags.slice();if(l.sortTags){p=o(p)}p=a(l,p,h,t)}if(l.autocomplete&&typeof e.fn.autocomplete=="function"&&l.allowEdit&&l.initLoad){e(h).autocomplete("option","source",p.availableTags)}}if(l.allowEdit){r.delegate("li.tagItem","click",function(){var n=e(this);var r=1;if(typeof l.onDelete=="function"){r=l.onDelete.call(this,e.trim(n.text()))}if(r){p=s(n,p,l.sortTags);if(l.updateURL!==""&&l.autoUpdate){u(p,l,t.id)}}if(typeof l.afterDelete=="function"){l.afterDelete.call(this,e.trim(n.text()))}if(l.autocomplete&&typeof e.fn.autocomplete=="function"&&l.initLoad){e(h).autocomplete("option","source",p.availableTags)}});e(h).keypress(function(r){var s=e(this);if(r.which===13||r.which===44||r.which===l.delimiter.charCodeAt(0)){r.preventDefault();if(s.val()!==""&&!n(e.trim(s.val()),p.assignedTags)){if(!l.allowAdd&&!n(e.trim(s.val()),p.availableTags)){alert(l.msgNoNewTag);return}if(l.maxTags>0&&p.assignedTags.length>=l.maxTags){alert("Maximum tags allowed: "+l.maxTags)}else{var o=e.trim(s.val());var a=1;if(typeof l.onAdd=="function"){a=l.onAdd.call(this,o)}if(a||typeof a=="undefined"){p=i(this,o,p,l.sorttags);if(l.updateURL!==""&&l.autoUpdate){u(p,l,t.id)}if(l.autocomplete&&typeof e.fn.autocomplete=="function"&&l.initload){e(h).autocomplete("option","source",p.availableTags)}if(typeof l.afterAdd=="function"){l.afterAdd.call(this,o)}}}s.val("");s.focus()}}});e(h).keydown(function(n){var i=e(this);if(n.which===8&&i.val()===""){var o=r.find(".tagItem:last").text();if(typeof l.onDelete=="function"){l.onDelete.call(this,e.trim(o))}p=s(r.find(".tagItem:last"),p,l.sortTags);if(l.updateURL!==""&&l.autoUpdate){u(p,l,t.id)}if(typeof l.afterDelete=="function"){l.afterDelete.call(this,e.trim(o))}if(l.autocomplete&&typeof e.fn.autocomplete=="function"&&l.initLoad){e(h).autocomplete("option","source",p.availableTags)}i.focus()}});if(l.autocomplete&&typeof e.fn.autocomplete=="function"&&l.initLoad){e(h).autocomplete({source:p.availableTags,select:function(r,s){var o=e(this);if(!n(e.trim(s.item.value),p.assignedTags)){if(l.maxTags>0&&p.assignedTags.length>=l.maxTags){alert("Maximum tags allowed: "+l.maxTags)}else{var a=e.trim(s.item.value);var f=1;if(typeof l.onAdd=="function"){f=l.onAdd.call(this,a)}if(f||typeof f=="undefined"){p=i(this,a,p,l.sortTags);if(l.updateURL!==""&&l.autoUpdate){u(p,l,t.id)}e(h).autocomplete("option","source",p.availableTags);if(typeof l.afterAdd=="function"){l.afterAdd.call(this,a)}}}o.focus()}o.val("");return false},minLength:l.minChars})}else if(l.autocomplete&&typeof e.fn.autocomplete=="function"){e(h).autocomplete({source:function(t,n){l.getData[l.queryname]=t.term;var r=e.getJSON(l.getURL,l.getData,function(e,t,r){n(e.availableTags)})},select:function(r,s){var o=e(this);if(!n(e.trim(s.item.value),p.assignedTags)){if(l.maxTags>0&&p.assignedTags.length>=l.maxTags){alert("Maximum tags allowed: "+l.maxTags)}else{var a=e.trim(s.item.value);var f=1;if(typeof l.onAdd=="function"){l.onAdd.call(this,a)}if(f||typeof f=="undefined"){p=i(this,e.trim(s.item.value),p,l.sortTags);if(l.updateURL!==""&&l.autoUpdate){u(p,l,t.id)}if(typeof l.afterAdd=="function"){l.afterAdd.call(this,a)}}}o.focus()}o.val("");return false},minLength:l.minChars})}e(h).focus(function(){if(e(h).val()===""&&l.autocomplete&&typeof e.fn.autocomplete=="function"&&l.initLoad){e(h).autocomplete("search","")}});r.click(function(){e(h).focus()})}this.getTags=function(){return p.assignedTags};return 1})}else if(typeof r=="string"&&t[r]){return t[r].apply(this,Array.prototype.slice.call(arguments,1))}};e.fn.tagHandler.defaults={allowEdit:true,allowAdd:true,assignedTags:[],autocomplete:false,autoUpdate:false,availableTags:[],className:"tagHandler",debug:false,delimiter:"",getData:{},getURL:"",initLoad:true,maxTags:0,minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list.",onAdd:{},onDelete:{},afterAdd:{},afterDelete:{},queryname:"q",sortTags:true,updateData:{},updateURL:""}})(jQuery)